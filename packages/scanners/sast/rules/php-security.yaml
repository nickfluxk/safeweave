rules:
  # ── PHP Security ────────────────────────────────────────────────────
  - id: safeweave.php.injection.file-include
    pattern-either:
      - pattern: include($INPUT)
      - pattern: include_once($INPUT)
      - pattern: require($INPUT)
      - pattern: require_once($INPUT)
    message: >-
      Dynamic file include with user-controlled path enables Local/Remote
      File Inclusion (LFI/RFI). Use a whitelist of allowed files.
    severity: ERROR
    languages: [php]
    metadata:
      cwe: ["CWE-98"]
      owasp: ["A03:2021"]
      category: security
      confidence: MEDIUM

  - id: safeweave.php.injection.sqli
    patterns:
      - pattern-either:
          - pattern: mysqli_query($CON, "..." . $VAR . "...")
          - pattern: $PDO->query("..." . $VAR . "...")
          - pattern: mysql_query("..." . $VAR . "...")
    message: >-
      SQL query with string concatenation. Use prepared statements:
      $stmt = $pdo->prepare("SELECT ... WHERE id = ?");
    severity: ERROR
    languages: [php]
    metadata:
      cwe: ["CWE-89"]
      owasp: ["A03:2021"]
      category: security
      confidence: HIGH

  - id: safeweave.php.injection.eval
    pattern-either:
      - pattern: eval($INPUT)
      - pattern: assert($INPUT)
      - pattern: preg_replace('/...(.*).../' . 'e', $INPUT, ...)
    message: >-
      eval/assert with dynamic input enables arbitrary code execution.
      Remove eval() usage entirely.
    severity: ERROR
    languages: [php]
    metadata:
      cwe: ["CWE-95"]
      category: security
      confidence: HIGH

  - id: safeweave.php.injection.system
    pattern-either:
      - pattern: system($INPUT)
      - pattern: exec($INPUT, ...)
      - pattern: shell_exec($INPUT)
      - pattern: passthru($INPUT)
      - pattern: popen($INPUT, ...)
      - pattern: proc_open($INPUT, ...)
    message: >-
      Command execution with dynamic input. Use escapeshellarg() and
      escapeshellcmd() or avoid shell execution entirely.
    severity: ERROR
    languages: [php]
    metadata:
      cwe: ["CWE-78"]
      owasp: ["A03:2021"]
      category: security
      confidence: HIGH

  - id: safeweave.php.crypto.md5-password
    pattern-either:
      - pattern: md5($PASSWORD)
      - pattern: sha1($PASSWORD)
    message: >-
      MD5/SHA1 used for password hashing. Use password_hash() with
      PASSWORD_BCRYPT or PASSWORD_ARGON2ID.
    severity: ERROR
    languages: [php]
    metadata:
      cwe: ["CWE-328"]
      category: security
      confidence: MEDIUM

  - id: safeweave.php.xss.echo-unsanitized
    pattern-either:
      - pattern: echo $INPUT;
      - pattern: print $INPUT;
    message: >-
      Output without htmlspecialchars(). Use htmlspecialchars($input,
      ENT_QUOTES, 'UTF-8') to prevent XSS.
    severity: WARNING
    languages: [php]
    metadata:
      cwe: ["CWE-79"]
      category: security
      confidence: LOW

  - id: safeweave.php.session.config
    pattern-either:
      - pattern: ini_set('session.cookie_httponly', '0')
      - pattern: ini_set('session.cookie_secure', '0')
      - pattern: ini_set('session.use_strict_mode', '0')
    message: >-
      Insecure PHP session configuration. Set cookie_httponly=1,
      cookie_secure=1, and use_strict_mode=1.
    severity: WARNING
    languages: [php]
    metadata:
      cwe: ["CWE-614"]
      category: security
      confidence: HIGH
